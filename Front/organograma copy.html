<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <meta name="color-scheme" content="light dark">
  <title>Organograma</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./static/css/style.css" />
</head>

<body class="body-gc-template">

  <header class="header-gc">
    <ul class="header-gc-template">
      <li class="header-gc-back">
        <a href="index.html" class="header-gc-back">
          <img class="back-icon" src="./static/imagens/icones/voltar.svg" alt="Back Icon">
        </a>
      </li>
      <li class="header-gc-nav">
        <nav class="header-gc-nav">
          <ul class="header-gc-nav-template">
            <li class="organograma indicador">
              <a href="home-admin.html">
                <img src="./static/imagens/icones/organograma-select.svg" alt="Organograma Icon">
                <p>Organograma</p>
              </a>
            </li>
            <li class="perfil">
              <a href="perfil.html">
                <img src="./static/imagens/icones/perfil.svg" alt="Perfil Icon">
                <p>Perfil</p>
              </a>
            </li>
            <li class="equipe">
              <a href="equipe.html">
                <img src="./static/imagens/icones/equipe.svg" alt="Equipe Icon">
                <p>Equipe</p>
              </a>
            </li>
          </ul>
        </nav>
      </li>
      <li class="header-gc-logout">
        <button id="btnLogout" class="btn-principal" onclick="logout()">Desconectar</button>
      </li>
    </ul>
  </header>

  <main class="main-gc main-gc-template">
    <section class="main-gc-section">
      <div class="organograma" role="tree" aria-label="Organograma da Empresa">
        <ul class="organograma-nivel nivel-1" role="treeitem" aria-expanded="true">
          <li class="organograma-no" tabindex="0" aria-label="Coordenação" aria-expanded="true" draggable="true">
            <div class="no-conteudo">
              <span class="no-titulo">Coordenação</span>
              <button class="toggle-btn" aria-label="Expandir/Contrair Subníveis"></button>
            </div>
            <ul class="organograma-nivel nivel-1-1" role="group">
              <li class="organograma-no" tabindex="0" aria-label="Núcleo Estratégico" draggable="true">
                <div class="no-conteudo">
                  <span class="no-titulo">Núcleo Estratégico</span>
                </div>
              </li>
            </ul>
          </li>
        </ul>
        <ul class="organograma-nivel nivel-2" role="treeitem" aria-expanded="true">
          <li class="organograma-no" tabindex="0" aria-label="Núcleo Infraestrutura" aria-expanded="true" draggable="true">
            <div class="no-conteudo">
              <span class="no-titulo">Núcleo Infraestrutura</span>
              <button class="toggle-btn" aria-label="Expandir/Contrair Subníveis"></button>
            </div>
            <ul class="organograma-nivel nivel-2-1" role="group">
              <li class="organograma-no" tabindex="0" aria-label="Comitê" draggable="true">
                <div class="no-conteudo">
                  <span class="no-titulo">Comitê</span>
                </div>
              </li>
              <li class="organograma-no" tabindex="0" aria-label="Logística" draggable="true">
                <div class="no-conteudo">
                  <span class="no-titulo">Logística</span>
                </div>
              </li>
              <li class="organograma-no" tabindex="0" aria-label="Almoxarifado" draggable="true">
                <div class="no-conteudo">
                  <span class="no-titulo">Almoxarifado</span>
                </div>
              </li>
            </ul>
          </li>
          <li class="organograma-no" tabindex="0" aria-label="Núcleo Político" draggable="true">
            <div class="no-conteudo">
              <span class="no-titulo">Núcleo Político</span>
            </div>
          </li>
        </ul>
      </div>
      <!-- Botões para adicionar/remover nós -->
      <div class="controle-organograma">
        <button id="adicionar-no">Adicionar Nó</button>
        <button id="remover-no">Remover Nó</button>
      </div>
    </section>
  </main>

  <script src="./static/js/AtualizarAlturaPagina.js" defer></script>
  <script>
    // script.js

    document.addEventListener('DOMContentLoaded', () => {
      const organograma = document.querySelector('.organograma');

      // Função para alternar a visibilidade dos subníveis com animação
      function toggleSubnivel(event) {
        event.stopPropagation();
        const btn = event.currentTarget;
        const no = btn.closest('.organograma-no');
        const subnivel = no.querySelector('.organograma-nivel');

        if (subnivel) {
          const isExpanded = no.getAttribute('aria-expanded') === 'true';
          no.setAttribute('aria-expanded', !isExpanded);

          if (isExpanded) {
            subnivel.classList.add('collapsed');
          } else {
            subnivel.classList.remove('collapsed');
          }
        }
      }

      // Adicionar event listeners aos botões de toggle
      function initializeToggleButtons() {
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        toggleButtons.forEach(btn => {
          btn.addEventListener('click', toggleSubnivel);
        });
      }

      initializeToggleButtons();

      // Funções para adicionar e remover nós
      const adicionarBtn = document.getElementById('adicionar-no');
      const removerBtn = document.getElementById('remover-no');

      adicionarBtn.addEventListener('click', () => {
        const novoNoTitulo = prompt('Digite o nome do novo nó:');
        if (novoNoTitulo) {
          // Escolher onde adicionar o novo nó (exemplo: como subnível do primeiro nó)
          const primeiroNo = organograma.querySelector('.organograma-no');
          let subnivel = primeiroNo.querySelector('.organograma-nivel');

          if (!subnivel) {
            // Se não houver subníveis, criar um
            subnivel = document.createElement('ul');
            subnivel.classList.add('organograma-nivel', 'nivel-adicional');
            subnivel.setAttribute('role', 'group');
            subnivel.classList.add('collapsed');
            primeiroNo.appendChild(subnivel);

            // Adicionar botão de toggle
            const toggleBtn = document.createElement('button');
            toggleBtn.classList.add('toggle-btn');
            toggleBtn.setAttribute('aria-label', 'Expandir Subníveis');
            primeiroNo.querySelector('.no-conteudo').appendChild(toggleBtn);

            // Atualizar atributos ARIA
            primeiroNo.setAttribute('aria-expanded', 'false');

            // Adicionar event listener ao novo botão
            toggleBtn.addEventListener('click', toggleSubnivel);
          }

          // Criar o novo nó
          const novoNo = document.createElement('li');
          novoNo.classList.add('organograma-no');
          novoNo.setAttribute('tabindex', '0');
          novoNo.setAttribute('aria-label', novoNoTitulo);
          novoNo.setAttribute('draggable', 'true');

          // Estrutura do conteúdo do nó
          novoNo.innerHTML = `
        <div class="no-conteudo">
          <span class="no-titulo">${novoNoTitulo}</span>
        </div>
      `;

          // Adicionar event listeners para drag and drop
          addDragAndDropListeners(novoNo);

          subnivel.appendChild(novoNo);
        }
      });

      removerBtn.addEventListener('click', () => {
        // Escolher qual nó remover (exemplo: o último nó adicionado)
        const todosNos = organograma.querySelectorAll('.organograma-no');
        if (todosNos.length > 0) {
          const ultimoNo = todosNos[todosNos.length - 1];
          const parentNivel = ultimoNo.parentElement;
          parentNivel.removeChild(ultimoNo);

          // Se o nível ficar vazio, removê-lo e atualizar atributos
          if (parentNivel.children.length === 0) {
            const noPai = parentNivel.parentElement;
            noPai.removeChild(parentNivel);

            // Atualizar atributos ARIA
            noPai.setAttribute('aria-expanded', 'false');

            // Remover botão de toggle
            const toggleBtn = noPai.querySelector('.toggle-btn');
            if (toggleBtn) {
              toggleBtn.remove();
            }
          }
        } else {
          alert('Não há nós para remover.');
        }
      });

      // Acessibilidade: Navegação via teclado
      organograma.addEventListener('keydown', (e) => {
        const foco = document.activeElement;
        if (foco.classList.contains('organograma-no')) {
          switch (e.key) {
            case 'ArrowRight':
              // Expandir se possível
              const subnivel = foco.querySelector('.organograma-nivel');
              if (subnivel && foco.getAttribute('aria-expanded') === 'false') {
                foco.setAttribute('aria-expanded', 'true');
                subnivel.classList.remove('collapsed');
              }
              break;
            case 'ArrowLeft':
              // Contrair se possível
              const subnivelContrair = foco.querySelector('.organograma-nivel');
              if (subnivelContrair && foco.getAttribute('aria-expanded') === 'true') {
                foco.setAttribute('aria-expanded', 'false');
                subnivelContrair.classList.add('collapsed');
              }
              break;
            case 'Enter':
            case ' ':
              // Simular clique no botão de toggle
              const btn = foco.querySelector('.toggle-btn');
              if (btn) btn.click();
              break;
            default:
              break;
          }
        }
      });

      // Funções para Drag and Drop
      let dragSrcEl = null;

      function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
        this.classList.add('dragging');
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault(); // Necessário para permitir o drop
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('over');
        return false;
      }

      function handleDragLeave(e) {
        this.classList.remove('over');
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation(); // Evita o comportamento padrão
        }

        this.classList.remove('over');

        if (dragSrcEl !== this) {
          // Evitar que um nó seja movido para dentro de si mesmo ou seus filhos
          if (isDescendant(dragSrcEl, this)) {
            alert('Não é possível mover um nó para dentro de si mesmo ou seus filhos.');
            return false;
          }

          // Inserir o nó arrastado antes do nó alvo
          const parser = new DOMParser();
          const doc = parser.parseFromString(e.dataTransfer.getData('text/html'), 'text/html');
          const draggedNode = doc.body.firstChild;

          // Clonar o nó para manter os event listeners
          const newDraggedNode = cloneNodeWithEvents(draggedNode);
          this.parentNode.insertBefore(newDraggedNode, this.nextSibling);

          // Remover o nó original
          dragSrcEl.parentNode.removeChild(dragSrcEl);
        }

        return false;
      }

      function handleDragEnd(e) {
        this.classList.remove('dragging');
        const nos = document.querySelectorAll('.organograma-no');
        nos.forEach(no => no.classList.remove('over'));
      }

      function isDescendant(parent, child) {
        let node = child.parentNode;
        while (node != null) {
          if (node === parent) {
            return true;
          }
          node = node.parentNode;
        }
        return false;
      }

      function cloneNodeWithEvents(node) {
        const newNode = node.cloneNode(true);
        // Reatribuir event listeners
        newNode.addEventListener('dragstart', handleDragStart);
        newNode.addEventListener('dragover', handleDragOver);
        newNode.addEventListener('dragleave', handleDragLeave);
        newNode.addEventListener('drop', handleDrop);
        newNode.addEventListener('dragend', handleDragEnd);

        // Reatribuir event listeners para botões de toggle
        const toggleBtn = newNode.querySelector('.toggle-btn');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleSubnivel);
        }

        // Reatribuir drag and drop para filhos
        const filhos = newNode.querySelectorAll('.organograma-no');
        filhos.forEach(filho => {
          addDragAndDropListeners(filho);
        });

        return newNode;
      }

      function addDragAndDropListeners(no) {
        no.addEventListener('dragstart', handleDragStart);
        no.addEventListener('dragover', handleDragOver);
        no.addEventListener('dragleave', handleDragLeave);
        no.addEventListener('drop', handleDrop);
        no.addEventListener('dragend', handleDragEnd);
      }

      // Inicializar Drag and Drop para nós existentes
      function initializeDragAndDrop() {
        const nos = document.querySelectorAll('.organograma-no');
        nos.forEach(no => {
          addDragAndDropListeners(no);
        });
      }

      initializeDragAndDrop();
    });

  </script>

</body>

</html>